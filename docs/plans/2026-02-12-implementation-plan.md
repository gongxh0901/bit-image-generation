# æ¸¸æˆç´ æç”Ÿæˆç³»ç»Ÿ - å®ç°è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-02-12  
**ç›®æ ‡**: å®Œæˆæ‰€æœ‰æœªå®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

---

## ğŸ“Š å½“å‰çŠ¶æ€æ¦‚è§ˆ

### å·²å®Œæˆ âœ…
- âœ… FastAPI åŸºç¡€æ¶æ„
- âœ… å‰ç«¯ React é‡æ„
- âœ… txt2img æ–‡ç”Ÿå›¾
- âœ… WebSocket è¿›åº¦å¹¿æ’­
- âœ… é£æ ¼åˆ—è¡¨å±•ç¤º
- âœ… ä»»åŠ¡åˆ—è¡¨ API

### æœªå®Œæˆ âŒ
- âŒ åŸºç¡€é£æ ¼æ”¯æŒï¼ˆæ— éœ€è®­ç»ƒï¼Œå¼€ç®±å³ç”¨ï¼‰
- âŒ img2img å›¾ç‰‡ä¸Šä¼ 
- âŒ è®­ç»ƒä¸­å¿ƒçœŸå®è®­ç»ƒ
- âŒ è®­ç»ƒåè‡ªåŠ¨åˆ›å»ºé£æ ¼
- âŒ å†å²ä»»åŠ¡åˆ—è¡¨é¡µé¢
- âŒ é£æ ¼çš„ç¼–è¾‘å’Œåˆ é™¤

---

## ğŸ¯ Phase 0: åŸºç¡€é£æ ¼æ”¯æŒ

### ç›®æ ‡
æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åŸºç¡€é£æ ¼ï¼Œç”¨æˆ·é¦–æ¬¡æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨åŸºç¡€é£æ ¼ç”Ÿæˆå›¾ç‰‡ï¼Œæ— éœ€è®­ç»ƒï¼Œåªæ ¹æ®æç¤ºè¯æˆ–ä¼ å…¥çš„å›¾ç‰‡ç”Ÿæˆã€‚

### åŸºç¡€é£æ ¼ç‰¹æ€§
- **æ— éœ€ LoRA**: ç›´æ¥ä½¿ç”¨ SDXL Base æ¨¡å‹ï¼Œä¸åŠ è½½ä»»ä½• LoRA
- **æ”¯æŒ txt2img**: æ–‡æœ¬ç”Ÿæˆå›¾ç‰‡
- **æ”¯æŒ img2img**: å›¾ç‰‡å‚è€ƒç”Ÿæˆï¼ˆPhase 1 å®ç°ä¸Šä¼ ï¼‰
- **ä¸å¯åˆ é™¤**: ä½œä¸ºç³»ç»Ÿé»˜è®¤é£æ ¼ï¼Œä¸å…è®¸åˆ é™¤
- **é»˜è®¤é€‰ä¸­**: å‰ç«¯æ‰“å¼€æ—¶è‡ªåŠ¨é€‰ä¸­åŸºç¡€é£æ ¼

### ä»»åŠ¡æ¸…å•
1. **æ•°æ®åº“æ¨¡å‹æ›´æ–°**
   - `Style` è¡¨æ·»åŠ  `is_base` å¸ƒå°”å­—æ®µï¼ˆæ ‡è®°æ˜¯å¦ä¸ºåŸºç¡€é£æ ¼ï¼‰
   - `Style` è¡¨æ·»åŠ  `is_trained` å¸ƒå°”å­—æ®µï¼ˆæ ‡è®°æ˜¯å¦ç»è¿‡è®­ç»ƒï¼‰
   - `GenerationTask` è¡¨æ·»åŠ  `input_image` å­—æ®µï¼ˆæ”¯æŒ img2imgï¼‰

2. **Pydantic Schema æ›´æ–°**
   - `StyleCreate` / `StyleRead` æ·»åŠ  `is_base`, `is_trained` å­—æ®µ
   - `GenerationTaskCreate` / `GenerationTaskRead` æ·»åŠ  `input_image` å­—æ®µ

3. **åç«¯å¯åŠ¨åˆå§‹åŒ–**
   - åœ¨ `lifespan` ä¸­æ£€æŸ¥å¹¶è‡ªåŠ¨åˆ›å»ºåŸºç¡€é£æ ¼
   - åŸºç¡€é£æ ¼æ•°æ®ï¼š
     ```python
     {
         "name": "åŸºç¡€é£æ ¼",
         "type": "ui",
         "lora_path": None,  # æ—  LoRA
         "trigger_words": None,
         "is_base": True,
         "is_trained": False,
         "preview_image": None
     }
     ```

4. **ç”Ÿæˆé€»è¾‘æ”¯æŒæ—  LoRA**
   - `task_runner.py` ä¸­ `_generation_task_worker` å·²æ”¯æŒæ— é£æ ¼ï¼ˆstyle_id=Noneï¼‰
   - ç¡®ä¿åŸºç¡€é£æ ¼ï¼ˆæ—  lora_pathï¼‰èƒ½æ­£ç¡®ç”Ÿæˆ
   - ä¸éœ€è¦ä¿®æ”¹ workflowï¼ŒComfyUI å®¢æˆ·ç«¯å·²ç»å¤„ç† None çš„æƒ…å†µ

5. **å‰ç«¯ç±»å‹æ›´æ–°**
   - `Style` æ¥å£æ·»åŠ  `is_base`, `is_trained` å­—æ®µ
   - `StyleCreate` æ¥å£æ·»åŠ å¯é€‰å­—æ®µ

6. **å‰ç«¯å±•ç¤ºä¼˜åŒ–**
   - `StyleList` ç»„ä»¶æ˜¾ç¤ºåŸºç¡€é£æ ¼ç‰¹æ®Šæ ‡è¯†ï¼ˆå¦‚å¾½ç« ã€å›¾æ ‡ï¼‰
   - åŸºç¡€é£æ ¼é»˜è®¤å±•å¼€æˆ–ç½®é¡¶æ˜¾ç¤º
   - åŸºç¡€é£æ ¼ä¸æ˜¾ç¤º"åˆ é™¤"æŒ‰é’®

### æ¶‰åŠæ–‡ä»¶
- `backend/app/models.py` - æ·»åŠ æ•°æ®åº“å­—æ®µ
- `backend/app/schemas.py` - æ›´æ–° Pydantic æ¨¡å‹
- `backend/app/main.py` - å¯åŠ¨æ—¶åˆå§‹åŒ–åŸºç¡€é£æ ¼
- `frontend/src/types/style.ts` - æ›´æ–° TypeScript ç±»å‹
- `frontend/src/pages/Home/components/StyleList.tsx` - æ˜¾ç¤ºåŸºç¡€é£æ ¼æ ‡è¯†

### API å˜åŒ–
- `GET /api/styles` - è¿”å›çš„é£æ ¼åˆ—è¡¨åŒ…å« `is_base`, `is_trained`
- `POST /api/styles` - åˆ›å»ºé£æ ¼æ—¶å¯æŒ‡å®š `is_base`ï¼ˆä»…é™ç®¡ç†å‘˜åœºæ™¯ï¼‰
- `POST /api/generate` - ç”Ÿæˆä»»åŠ¡æ”¯æŒä¸æŒ‡å®š `style_id` æˆ–æŒ‡å®šåŸºç¡€é£æ ¼

---

## ğŸ¯ Phase 1: img2img å›¾ç‰‡ä¸Šä¼ 

### ç›®æ ‡
å®ç°çœŸæ­£çš„å›¾ç”Ÿå›¾åŠŸèƒ½ï¼Œæ”¯æŒä¸Šä¼ å‚è€ƒå›¾ç‰‡ã€‚

### ä»»åŠ¡æ¸…å•
1. **åç«¯æ–‡ä»¶ä¸Šä¼  API**
   - æ·»åŠ  `POST /api/upload` ç«¯ç‚¹
   - æ”¯æŒ multipart/form-data ä¸Šä¼ 
   - ä¿å­˜åˆ° `uploads/` ç›®å½•
   - è¿”å›å¯è®¿é—®çš„ URL è·¯å¾„

2. **GenerationTask æ•°æ®åº“æ›´æ–°**
   - æ·»åŠ  `input_image` å­—æ®µï¼ˆå·²åœ¨ Phase 0 å®Œæˆï¼‰
   - å­˜å‚¨ä¸Šä¼ å›¾ç‰‡çš„è·¯å¾„

3. **å‰ç«¯ä¸Šä¼ ç»„ä»¶**
   - åˆ›å»º `ImageUploader` ç»„ä»¶
   - æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
   - æ˜¾ç¤ºä¸Šä¼ é¢„è§ˆ
   - é›†æˆåˆ° `GenerationPanel`

4. **å·¥ä½œæµæ¨¡æ¿æ›´æ–°**
   - `comfyui_client.py` ä¸­ `build_img2img_prompt`
   - ä½¿ç”¨çœŸå®ä¸Šä¼ çš„å›¾ç‰‡è·¯å¾„æ›¿æ¢ `input.png` å ä½ç¬¦

### æ¶‰åŠæ–‡ä»¶
- `backend/app/main.py` - æ·»åŠ ä¸Šä¼ ç«¯ç‚¹
- `backend/app/models.py` - æ·»åŠ  input_image å­—æ®µï¼ˆPhase 0 ä¸€èµ·å®Œæˆï¼‰
- `backend/app/task_runner.py` - ä¼ é€’çœŸå®å›¾ç‰‡è·¯å¾„
- `backend/app/comfyui_client.py` - æ›´æ–° workflow æ„å»º
- `frontend/src/services/upload.ts` (æ–°å»º) - ä¸Šä¼ æœåŠ¡
- `frontend/src/pages/Home/components/GenerationPanel.tsx` - é›†æˆæœ¬åœ°ä¸Šä¼ 

---

## ğŸ¯ Phase 2: è®­ç»ƒä¸­å¿ƒé‡æ„

### ç›®æ ‡
è®­ç»ƒå®Œæˆåè‡ªåŠ¨åˆ›å»ºé£æ ¼ï¼Œæ‰“é€šè®­ç»ƒ-ä½¿ç”¨æµç¨‹ã€‚

### ä»»åŠ¡æ¸…å•
1. **æ•°æ®åº“å…³è”æ”¹é€ **
   - `TrainingJob` æ·»åŠ  `output_lora_path` å­—æ®µï¼ˆè®­ç»ƒç»“æœè·¯å¾„ï¼‰
   - ä¿®æ”¹è®­ç»ƒæµç¨‹ï¼šåˆ›å»ºè®­ç»ƒä»»åŠ¡æ—¶åŒæ­¥åˆ›å»ºé£æ ¼ï¼ˆstatus=trainingï¼‰
   - é£æ ¼åˆå§‹çŠ¶æ€ï¼š`is_trained=False`, `lora_path=None`

2. **è®­ç»ƒå®Œæˆå›è°ƒ**
   - è®­ç»ƒå®Œæˆåæ›´æ–°é£æ ¼è®°å½•
   - è®¾ç½® `lora_path` å’Œ `is_trained=True`
   - æ›´æ–°é£æ ¼çŠ¶æ€ä¸ºå¯ç”¨

3. **å‰ç«¯æµç¨‹æ”¹é€ **
   - è®­ç»ƒè¡¨å•å…ˆåˆ›å»ºé£æ ¼ï¼Œå†å¯åŠ¨è®­ç»ƒ
   - è®­ç»ƒé¡µé¢æ˜¾ç¤ºå…³è”çš„é£æ ¼ä¿¡æ¯
   - è®­ç»ƒå®Œæˆåé£æ ¼è‡ªåŠ¨å‡ºç°åœ¨åˆ—è¡¨ä¸­

### æ¶‰åŠæ–‡ä»¶
- `backend/app/models.py` - æ·»åŠ  output_lora_path
- `backend/app/task_runner.py` - è®­ç»ƒå®Œæˆåæ›´æ–°é£æ ¼
- `backend/app/schemas.py` - æ›´æ–° TrainingJob schema
- `frontend/src/stores/trainingStore.ts` - æµç¨‹æ”¹é€ 
- `frontend/src/pages/Training/components/StyleForm.tsx` - å…ˆåˆ›å»ºé£æ ¼

---

## ğŸ¯ Phase 3: å†å²ä»»åŠ¡åˆ—è¡¨

### ç›®æ ‡
å±•ç¤ºæ‰€æœ‰è®­ç»ƒå’Œç”Ÿæˆä»»åŠ¡çš„å†å²è®°å½•ã€‚

### ä»»åŠ¡æ¸…å•
1. **å‰ç«¯æœåŠ¡å±‚**
   - åˆ›å»º `task.ts` æœåŠ¡ï¼Œè°ƒç”¨ `/api/tasks` æ¥å£
   - åˆ›å»º `taskStore.ts` çŠ¶æ€ç®¡ç†

2. **å†å²ä»»åŠ¡é¡µé¢**
   - åˆ›å»º `History/index.tsx` é¡µé¢ç»„ä»¶
   - è¡¨æ ¼å±•ç¤ºï¼šä»»åŠ¡ç±»å‹ã€çŠ¶æ€ã€è¿›åº¦ã€åˆ›å»ºæ—¶é—´ã€è¾“å‡ºå›¾ç‰‡
   - æ”¯æŒç­›é€‰å’Œåˆ†é¡µ

3. **å¯¼èˆªèœå•**
   - `App.tsx` æ·»åŠ å†å²ä»»åŠ¡è·¯ç”±
   - `Layout` ç»„ä»¶æ·»åŠ å¯¼èˆªé“¾æ¥

### æ¶‰åŠæ–‡ä»¶
- `frontend/src/services/task.ts` (æ–°å»º)
- `frontend/src/stores/taskStore.ts` (æ–°å»º)
- `frontend/src/pages/History/index.tsx` (æ–°å»º)
- `frontend/src/App.tsx` - æ·»åŠ è·¯ç”±
- `frontend/src/components/Layout/` - æ·»åŠ å¯¼èˆª

---

## ğŸ¯ Phase 4: é£æ ¼ç®¡ç†å®Œå–„

### ç›®æ ‡
æ”¯æŒé£æ ¼çš„ç¼–è¾‘å’Œåˆ é™¤ã€‚

### ä»»åŠ¡æ¸…å•
1. **åç«¯ API**
   - `PUT /api/styles/{id}` - æ›´æ–°é£æ ¼ä¿¡æ¯
   - `DELETE /api/styles/{id}` - åˆ é™¤é£æ ¼ï¼ˆåŸºç¡€é£æ ¼ä¸å¯åˆ é™¤ï¼‰

2. **å‰ç«¯ç¼–è¾‘åŠŸèƒ½**
   - `EditStyleModal.tsx` ç¼–è¾‘å¼¹çª—
   - æ”¯æŒä¿®æ”¹åç§°ã€è§¦å‘è¯ã€é¢„è§ˆå›¾

3. **å‰ç«¯åˆ é™¤åŠŸèƒ½**
   - `StyleList` æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆåŸºç¡€é£æ ¼éšè—ï¼‰
   - åˆ é™¤å‰ç¡®è®¤å¯¹è¯æ¡†

### æ¶‰åŠæ–‡ä»¶
- `backend/app/main.py` - æ·»åŠ  PUT/DELETE ç«¯ç‚¹
- `frontend/src/services/style.ts` - æ·»åŠ æ›´æ–°/åˆ é™¤æ–¹æ³•
- `frontend/src/pages/Home/components/EditStyleModal.tsx` (æ–°å»º)
- `frontend/src/pages/Home/components/StyleList.tsx` - æ·»åŠ æ“ä½œæŒ‰é’®

---

## ğŸ¯ Phase 5: Kohya_ss é›†æˆ

### ç›®æ ‡
é›†æˆçœŸå®è®­ç»ƒæµç¨‹ï¼Œæ›¿ä»£æ¨¡æ‹Ÿè®­ç»ƒã€‚

### ä»»åŠ¡æ¸…å•
1. **æŠ€æœ¯è°ƒç ”**
   - Kohya_ss API æ–¹æ¡ˆï¼ˆæ˜¯å¦æœ‰ HTTP APIï¼‰
   - æˆ–ç›´æ¥è°ƒç”¨ Kohya_ss çš„å‘½ä»¤è¡Œè„šæœ¬
   - è®­ç»ƒå‚æ•°æ˜ å°„

2. **é€‚é…å™¨å®ç°**
   - åˆ›å»º `kohya_adapter.py`
   - å®ç°è®­ç»ƒä»»åŠ¡æäº¤
   - å®ç°è¿›åº¦è·å–
   - å®ç°ç»“æœå›è°ƒ

3. **æµç¨‹æ›¿æ¢**
   - æ›¿æ¢ `_training_job_worker` ä¸­çš„æ¨¡æ‹Ÿé€»è¾‘
   - é›†æˆçœŸå®è®­ç»ƒæµç¨‹

### æ¶‰åŠæ–‡ä»¶
- `backend/app/training/kohya_adapter.py` (æ–°å»º)
- `backend/app/task_runner.py` - æ›¿æ¢è®­ç»ƒé€»è¾‘

---

## ğŸ“… å®æ–½é¡ºåºå»ºè®®

| é¡ºåº | Phase | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|-------|----------|--------|------|
| 1 | Phase 0: åŸºç¡€é£æ ¼ | åŠå¤© | P0 | æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å…ˆå®Œæˆ |
| 2 | Phase 1: img2imgä¸Šä¼  | 1å¤© | P0 | å®Œå–„ç”ŸæˆåŠŸèƒ½ |
| 3 | Phase 2: è®­ç»ƒä¸­å¿ƒé‡æ„ | 1-2å¤© | P1 | æ‰“é€šè®­ç»ƒ-ä½¿ç”¨æµç¨‹ |
| 4 | Phase 3: å†å²ä»»åŠ¡ | 1å¤© | P1 | æå‡ç”¨æˆ·ä½“éªŒ |
| 5 | Phase 4: é£æ ¼ç®¡ç† | åŠå¤© | P2 | å®Œå–„åŠŸèƒ½ |
| 6 | Phase 5: Kohya_ss | 3-5å¤© | P2 | çœŸå®è®­ç»ƒæ”¯æŒ |

### ä¾èµ–å…³ç³»
```
Phase 0 (åŸºç¡€é£æ ¼)
  â”‚
  â”œâ”€â”€> Phase 1 (img2imgä¸Šä¼ ) - ä¾èµ–åŸºç¡€é£æ ¼çš„å›¾ç‰‡æ”¯æŒ
  â”‚
  â”œâ”€â”€> Phase 2 (è®­ç»ƒä¸­å¿ƒ) - ä¾èµ–åŸºç¡€é£æ ¼ä½œä¸ºå¯¹æ¯”åŸºå‡†
  â”‚
  â””â”€â”€> Phase 4 (é£æ ¼ç®¡ç†) - ä¾èµ–åŸºç¡€é£æ ¼çš„ä¸å¯åˆ é™¤é€»è¾‘
```

---

## ğŸ”„ æ–‡æ¡£åŒæ­¥æé†’

æ ¹æ® AGENTS.md è§„åˆ™ï¼Œä»¥ä¸‹æ”¹åŠ¨éœ€è¦åŒæ­¥æ›´æ–°æ–‡æ¡£ï¼š
- API ç«¯ç‚¹å˜æ›´ â†’ æ›´æ–° `backend/README.md`
- æ•°æ®åº“æ¨¡å‹å˜æ›´ â†’ æ›´æ–° `backend/app/AGENTS.md`
- å‰ç«¯è·¯ç”±å˜æ›´ â†’ æ›´æ–° `frontend/README.md`
- é¡¹ç›®ç»“æ„å˜åŒ– â†’ æ›´æ–°æ‰€æœ‰ `AGENTS.md` å’Œ `README.md`

---

## ğŸ“ æŠ€æœ¯å¤‡æ³¨

### åŸºç¡€é£æ ¼çš„ç‰¹æ®Šå¤„ç†
```python
# åˆ›å»ºåŸºç¡€é£æ ¼ï¼ˆlifespan ä¸­ï¼‰
async def init_base_style(session):
    result = await session.execute(
        select(Style).where(Style.is_base == True)
    )
    if not result.scalar_one_or_none():
        base_style = Style(
            name="åŸºç¡€é£æ ¼",
            type="ui",
            is_base=True,
            is_trained=False,
            # lora_path=None, trigger_words=None
        )
        session.add(base_style)
        await session.commit()

# åˆ é™¤é£æ ¼æ—¶æ£€æŸ¥
if style.is_base:
    raise HTTPException(400, "ä¸èƒ½åˆ é™¤åŸºç¡€é£æ ¼")
```

### ç”Ÿæˆé€»è¾‘å¤„ç†
```python
# task_runner.py ä¸­å·²æ”¯æŒæ—  LoRA
if style and style.lora_name:
    # ä½¿ç”¨ LoRA
    workflow = build_txt2img_prompt(..., lora_name=style.lora_name)
else:
    # åŸºç¡€é£æ ¼ï¼šä¸ä½¿ç”¨ LoRA
    workflow = build_txt2img_prompt(..., lora_name=None)
```

---

## âœ… æˆåŠŸæ ‡å‡†

### Phase 0 æˆåŠŸæ ‡å‡†
- [ ] åç«¯å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º"åŸºç¡€é£æ ¼"
- [ ] ç”¨æˆ·é¦–æ¬¡æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨åŸºç¡€é£æ ¼ç”Ÿæˆå›¾ç‰‡
- [ ] åŸºç¡€é£æ ¼æ—  LoRAï¼Œç›´æ¥ä½¿ç”¨ SDXL Base æ¨¡å‹
- [ ] åŸºç¡€é£æ ¼åœ¨ UI ä¸­æœ‰ç‰¹æ®Šæ ‡è¯†ï¼ˆå¾½ç« æˆ–å›¾æ ‡ï¼‰
- [ ] åŸºç¡€é£æ ¼ä¸èƒ½è¢«åˆ é™¤
- [ ] ç”Ÿæˆä»»åŠ¡æ”¯æŒä¸é€‰æ‹©é£æ ¼ï¼ˆé»˜è®¤ä½¿ç”¨åŸºç¡€é€»è¾‘ï¼‰

### æ•´ä½“æˆåŠŸæ ‡å‡†
- [ ] ç”¨æˆ·é¦–æ¬¡æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨åŸºç¡€é£æ ¼ç”Ÿæˆå›¾ç‰‡
- [ ] æ”¯æŒä¸Šä¼ å›¾ç‰‡è¿›è¡Œ img2img ç”Ÿæˆ
- [ ] è®­ç»ƒå®Œæˆåè‡ªåŠ¨åœ¨é£æ ¼åˆ—è¡¨æ˜¾ç¤ºæ–°é£æ ¼
- [ ] å¯ä»¥æŸ¥çœ‹å†å²ä»»åŠ¡è®°å½•
- [ ] å¯ä»¥ç¼–è¾‘å’Œåˆ é™¤é£æ ¼ï¼ˆåŸºç¡€é£æ ¼é™¤å¤–ï¼‰

